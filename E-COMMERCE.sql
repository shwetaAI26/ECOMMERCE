-- Create the orders table

CREATE OR REPLACE TABLE DATACLOUDDISPATCHSI.ECOMMERCE.CUSTOMER_ORDERS (
  CUSTOMER_ID  NUMBER,
  ORDER_ID     NUMBER,
  ORDER_DATE   DATE,
  ORDER_VALUE  NUMBER(10,2),
  PRODUCT_ID   NUMBER
);

-- Insert sample e-commerce data

INSERT INTO DATACLOUDDISPATCHSI.ECOMMERCE.CUSTOMER_ORDERS (CUSTOMER_ID, ORDER_ID, ORDER_DATE, ORDER_VALUE, PRODUCT_ID) VALUES
(1001,50001,'2023-01-15', 89.99,201),
(1001,50022,'2023-03-02',120.49,305),
(1002,50110,'2023-05-11', 45.00,110),
(1003,50155,'2023-02-19',239.00,402),
(1003,50190,'2023-05-22',130.00,233),
(1003,50201,'2023-06-01', 99.99,110),
(1004,50333,'2023-01-05', 19.99,502),
(1001,50390,'2023-11-11',301.00,900),
(1005,50400,'2023-12-12', 67.50,702);

-- Quick preview of raw orders

SELECT * FROM DATACLOUDDISPATCHSI.ECOMMERCE.CUSTOMER_ORDERS ORDER BY ORDER_DATE;

----------------------------------------------------------------

-- Step 2: Build customer segments (frequency & average order value)

----------------------------------------------------------------

-- Aggregate behavior to create one row per customer

CREATE OR REPLACE TABLE DATACLOUDDISPATCHSI.ECOMMERCE.CUSTOMER_SEGMENTS AS
SELECT
    CUSTOMER_ID,
    COUNT(ORDER_ID)  AS PURCHASE_COUNT,
    AVG(ORDER_VALUE) AS AVG_ORDER_VALUE
FROM DATACLOUDDISPATCHSI.ECOMMERCE.CUSTOMER_ORDERS
WHERE ORDER_DATE BETWEEN '2023-01-01' AND '2023-12-31'
GROUP BY CUSTOMER_ID;

-- Inspect segments

SELECT * FROM DATACLOUDDISPATCHSI.ECOMMERCE.CUSTOMER_SEGMENTS ORDER BY PURCHASE_COUNT DESC;
